name: Deploy to NAS

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - '.gitignore'
      - '.claude/**'
      - '.roo/**'
      - 'DESIGN_SPEC.md'
      - 'LICENSE'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/crosshot-ai
  NAS_DEPLOY_PATH: /share/minyic-volumn/crosshot-ai
  DOCKER: /share/CACHEDEV1_DATA/.qpkg/container-station/usr/bin/.libs/docker

jobs:
  # ──────────────────────────────────────
  # Detect which components changed
  # ──────────────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      crawler: ${{ steps.filter.outputs.crawler }}
      analyst: ${{ steps.filter.outputs.analyst }}
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
      infra: ${{ steps.filter.outputs.infra }}
      any_image: ${{ steps.check.outputs.any_image }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            crawler:
              - 'apps/agent-crawler/**'
              - 'apps/shared/**'
              - 'pyproject.toml'
              - 'uv.lock'
            analyst:
              - 'apps/agent-analyst/**'
              - 'apps/shared/**'
              - 'pyproject.toml'
              - 'uv.lock'
            api:
              - 'apps/api/**'
              - 'apps/shared/**'
              - 'pyproject.toml'
              - 'uv.lock'
            web:
              - 'web/**'
            infra:
              - 'docker-compose.yml'
      - id: check
        run: |
          if [[ "${{ steps.filter.outputs.crawler }}" == "true" || \
                "${{ steps.filter.outputs.analyst }}" == "true" || \
                "${{ steps.filter.outputs.api }}" == "true" || \
                "${{ steps.filter.outputs.web }}" == "true" || \
                "${{ steps.filter.outputs.infra }}" == "true" ]]; then
            echo "any_image=true" >> "$GITHUB_OUTPUT"
          else
            echo "any_image=false" >> "$GITHUB_OUTPUT"
          fi

  # ──────────────────────────────────────
  # Build changed images in parallel
  # ──────────────────────────────────────
  build:
    needs: changes
    if: needs.changes.outputs.any_image == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - name: crawler
            file: apps/agent-crawler/Dockerfile
            context: .
            changed: ${{ needs.changes.outputs.crawler }}
          - name: analyst
            file: apps/agent-analyst/Dockerfile
            context: .
            changed: ${{ needs.changes.outputs.analyst }}
          - name: api
            file: apps/api/Dockerfile
            context: .
            changed: ${{ needs.changes.outputs.api }}
          - name: web
            file: web/Dockerfile
            context: ./web
            changed: ${{ needs.changes.outputs.web }}
    steps:
      - name: Skip unchanged image
        if: matrix.changed != 'true'
        run: echo "Skipping ${{ matrix.name }} — no changes"

      - uses: actions/checkout@v4
        if: matrix.changed == 'true'

      - uses: docker/login-action@v3
        if: matrix.changed == 'true'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3
        if: matrix.changed == 'true'

      - uses: docker/build-push-action@v6
        if: matrix.changed == 'true'
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-${{ matrix.name }}:latest
            ${{ env.IMAGE_PREFIX }}-${{ matrix.name }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}

  # ──────────────────────────────────────
  # Deploy to NAS via Tailscale + SSH
  # ──────────────────────────────────────
  deploy:
    needs: [changes, build]
    if: needs.changes.outputs.any_image == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.NAS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.NAS_TAILSCALE_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Copy compose file to NAS
        if: needs.changes.outputs.infra == 'true'
        run: |
          ssh ${{ secrets.NAS_USER }}@${{ secrets.NAS_TAILSCALE_IP }} "mkdir -p ${{ env.NAS_DEPLOY_PATH }}"
          scp docker-compose.yml ${{ secrets.NAS_USER }}@${{ secrets.NAS_TAILSCALE_IP }}:${{ env.NAS_DEPLOY_PATH }}/

      - name: Deploy on NAS
        run: |
          ssh ${{ secrets.NAS_USER }}@${{ secrets.NAS_TAILSCALE_IP }} << 'EOF'
            DOCKER="${{ env.DOCKER }}"
            COMPOSE="$DOCKER compose"
            cd ${{ env.NAS_DEPLOY_PATH }}

            # Ensure data directories exist
            mkdir -p ${{ env.NAS_DEPLOY_PATH }}/data/{redis,pgdata,media,opensearch}

            export DATA_DIR="${{ env.NAS_DEPLOY_PATH }}/data"

            # Login to GHCR
            echo "${{ secrets.GHCR_TOKEN }}" | $DOCKER login ghcr.io -u ${{ github.repository_owner }} --password-stdin

            # Pull new images
            $COMPOSE pull

            # Restart containers (recreate only changed images)
            $COMPOSE up -d --remove-orphans

            # Wait for API to be ready (retry up to 30s)
            echo "Waiting for API..."
            for i in $(seq 1 6); do
              if curl -sf http://localhost:8000/health > /dev/null 2>&1; then
                echo "API is healthy"
                break
              fi
              [ $i -eq 6 ] && echo "API health check timed out" && exit 1
              sleep 5
            done

            # Verify web
            curl -sf http://localhost:3000/ > /dev/null && echo "Web is healthy" || echo "Web health check failed"
          EOF

      - name: Verify deployment via Tailscale
        run: |
          for i in $(seq 1 4); do
            curl -sf http://${{ secrets.NAS_TAILSCALE_IP }}:8000/health && echo "Deployment verified" && exit 0
            sleep 5
          done
          echo "Verification failed" && exit 1
